rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the document
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // Users collection - users can read all, but only write their own
    match /users/{userId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && isOwner(userId);
      allow update, delete: if isAuthenticated() && isOwner(userId);
    }
    
    // User progress - only the user can read/write their own progress
    match /userProgress/{userId} {
      allow read, write: if isAuthenticated() && isOwner(userId);
    }
    
    // Conversations - users can only access their own conversations
    match /conversations/{conversationId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Community chat - authenticated users can read all, write with their own userId
    match /communityChat/{messageId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() && (resource.data.userId == request.auth.uid || request.auth.token.admin == true);
    }
    
    // Private messages - only sender and receiver can access
    match /privateMessages/{messageId} {
      allow read: if isAuthenticated() && 
        (resource.data.senderId == request.auth.uid || 
         resource.data.receiverId == request.auth.uid);
      allow create: if isAuthenticated() && request.resource.data.senderId == request.auth.uid;
      allow delete: if isAuthenticated() && resource.data.senderId == request.auth.uid;
    }
    
    // Flagged messages - all authenticated users can read/create
    match /flaggedMessages/{messageId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated();
      allow update, delete: if request.auth.token.admin == true;
    }
    
    // Moderation log - admins only
    match /moderationLog/{logId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated();
    }
    
    // Moderation queue - admins only
    match /moderationQueue/{queueId} {
      allow read: if isAuthenticated();
      allow write: if request.auth.token.admin == true;
    }
    
    // Video sessions - authenticated users can read all active sessions
    match /videoSessions/{sessionId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.hostId == request.auth.uid;
      allow update: if isAuthenticated() && (
        resource.data.hostId == request.auth.uid || 
        request.auth.uid in resource.data.participants
      );
      allow delete: if isAuthenticated() && resource.data.hostId == request.auth.uid;
    }
    
    // Chizuk videos - all authenticated users can read, only uploader can delete
    match /chizukVideos/{videoId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && request.resource.data.uploadedBy == request.auth.uid;
      allow update: if isAuthenticated();
      allow delete: if isAuthenticated() && resource.data.uploadedBy == request.auth.uid;
    }
    
    // Study profiles - all authenticated users can read, only owner can write
    match /studyProfiles/{userId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && isOwner(userId);
    }
    
    // Learning logs - only the user can access their own logs
    match /learningLogs/{logId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
    
    // Completed lessons - only the user can access their own
    match /completedLessons/{lessonId} {
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;
      allow create: if isAuthenticated() && request.resource.data.userId == request.auth.uid;
      allow update, delete: if isAuthenticated() && resource.data.userId == request.auth.uid;
    }
  }
}
